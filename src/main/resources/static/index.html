<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Curl Parser</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 100%; height: 150px; }
        #executeBtn:disabled { background-color: #ccc; cursor: not-allowed; }
        #logs { background: #f4f4f4; padding: 10px; height: 300px; overflow-y: scroll; border: 1px solid #ddd; }
        .warning { color: red; }

        .section-header {
          cursor: pointer;
          background: #e0e0e0;
          padding: 5px;
          margin-top: 5px;
          font-weight: bold;
          display: flex;
          align-items: center;
        }

        .arrow {
          display: inline-block;
          transition: transform 0.2s ease;
          margin-right: 8px;
        }

        .arrow.collapsed { transform: rotate(0deg); }
        .arrow.expanded { transform: rotate(90deg); }

        .section-body {
          display: none;
          white-space: pre-wrap;
          padding: 5px;
          border-left: 2px solid #aaa;
          margin-bottom: 5px;
          background: #fff;
        }

        /* üîÑ Loader Styles */
        #loader {
          display: none;
          margin-top: 10px;
          text-align: center;
        }
        .spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #3498db;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          animation: spin 1s linear infinite;
          margin: 0 auto;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<h1>Curl Parser - Test Your API from Raw cURL Instantly ‚ö°</h1>
<p class="warning">Prerequisite: Make sure the cURL API has been first hit via Postman.</p>

<textarea id="curlInput" placeholder="Enter your cURL command here..."></textarea>
<br><br>
<button id="executeBtn" disabled>Execute</button>

<!-- üîÑ Loader element -->
<div id="loader">
    <div class="spinner"></div>
    <p>Executing request, please wait...</p>
</div>

<h2>Results</h2>
<div id="logs"></div>
<script>
    const curlInput = document.getElementById("curlInput");
    const executeBtn = document.getElementById("executeBtn");
    const logs = document.getElementById("logs");
    const loader = document.getElementById("loader");

    curlInput.addEventListener("input", () => {
      const trimmed = curlInput.value.trim();
      executeBtn.disabled = !(trimmed && trimmed.startsWith("curl --location "));
    });

    function highlightBlock(blockLines) {
      let blockColor = "red";
      if (blockLines.some(l => l.includes("Passed"))) {
        blockColor = "green";
      } else if (blockLines.some(l => l.includes("Test Case Skipped"))) {
        blockColor = "orange";
      }

      return blockLines.map((line, idx) => {
        let highlighted = line;

        highlighted = highlighted.replace(/API Status Code:\s*(\d+)/g, (match, code) => {
          return `API Status Code: <span style="color:${blockColor}; font-weight:bold">${code}</span>`;
        });

        highlighted = highlighted
          .replace(/\bPassed\b/g, `<span style="color:green; font-weight:bold">Passed</span>`)
          .replace(/\bFailed\b/g, `<span style="color:red; font-weight:bold">Failed</span>`)
          .replace(/Test Case Skipped/g, `<span style="color:orange; font-weight:bold">Test Case Skipped</span>`);

        if (idx === 0 && line.startsWith("=== Running")) {
          let statusText = "";
          if (blockColor === "green") statusText = " ‚úÖ Passed";
          else if (blockColor === "red") statusText = " ‚ùå Failed";
          else if (blockColor === "orange") statusText = " ‚ö†Ô∏è Skipped";

          highlighted += ` <span style="color:${blockColor}; font-weight:bold">${statusText}</span>`;
        }

        return highlighted;
      });
    }

    function appendLog(message) {
      const lines = message.split("\n");
      let currentBlock = [];

      function flushBlock() {
        if (currentBlock.length === 0) return;
        const highlightedLines = highlightBlock(currentBlock);

        // always create a new collapsible block for "=== Running"
        const header = document.createElement("div");
        header.className = "section-header";

        const arrow = document.createElement("span");
        arrow.className = "arrow collapsed";
        arrow.textContent = "‚ñ∂";

        const text = document.createElement("span");
        text.innerHTML = highlightedLines[0]; // block header

        const body = document.createElement("div");
        body.className = "section-body";

        header.addEventListener("click", () => {
          const expanded = body.style.display === "block";
          body.style.display = expanded ? "none" : "block";
          arrow.textContent = expanded ? "‚ñ∂" : "‚ñº";
        });

        header.appendChild(arrow);
        header.appendChild(text);
        logs.appendChild(header);
        logs.appendChild(body);

        highlightedLines.slice(1).forEach(line => {
          body.innerHTML += line + "<br>";
        });

        currentBlock = [];
      }

      lines.forEach(line => {
        if (line.startsWith("=== Running")) {
          flushBlock();
          currentBlock.push(line);
        } else {
          currentBlock.push(line);
        }
      });

      flushBlock();
      logs.scrollTop = logs.scrollHeight;
    }

    executeBtn.addEventListener("click", async () => {
      const curlCommand = curlInput.value.trim();

      if (!curlCommand.startsWith("curl --location ")) {
        appendLog("‚ùå Invalid cURL format. Must start with: curl --location");
        return;
      }

      executeBtn.disabled = true;
      loader.style.display = "block"; // show loader
      logs.innerHTML = ""; // clear old logs

      // ‚úÖ Show Execution Starts as plain text (not collapsible)
      const execStart = document.createElement("div");
      execStart.style.fontWeight = "bold";
      execStart.style.marginBottom = "10px";
      execStart.textContent = "üöÄ Execution Starts...";
      logs.appendChild(execStart);

      const curlCmdBlock = document.createElement("pre");
      curlCmdBlock.textContent = curlCommand;
      curlCmdBlock.style.background = "#fff";
      curlCmdBlock.style.padding = "5px";
      curlCmdBlock.style.border = "1px solid #ddd";
      logs.appendChild(curlCmdBlock);

      try {
        const response = await fetch("/api/execute-curl", {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: curlCommand
        });

        const text = await response.text();
        appendLog(text);

        // ‚úÖ Show Execution Finished
        const execEnd = document.createElement("div");
        execEnd.style.fontWeight = "bold";
        execEnd.style.marginTop = "10px";
        execEnd.textContent = "üèÅ Execution Finished";
        logs.appendChild(execEnd);

      } catch (err) {
        appendLog("‚ùå Error: " + err.message);
      } finally {
        loader.style.display = "none"; // hide loader
        const trimmed = curlInput.value.trim();
        executeBtn.disabled = !(trimmed && trimmed.startsWith("curl --location "));
      }
    });
</script>

</body>
</html>
